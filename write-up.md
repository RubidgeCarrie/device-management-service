# Architecture Decision Record

# Assumptions

1. Attributes: static/ long lived configuration for devices
1. Device details do not include their status
2. We want to save the history of a device status/configuration changes


# Database choice
Querying a 
Given the nature of the endpoints they could have been implemented on a NoSQL database, such as MongoDB.


# API server

I chose to use python since I had been wanting an opportunity to try FastAPI
If I were to use  `Node.js` I would have gone with [Express](https://expressjs.com/) for the API's.

I have previously made the decision to avoid ORM's and use "raw" SQL and our own schema migration system using custom resources in AWS instead of leaning on something a package like `alembic` from `SQLAlchemy`

I wanted to try see how these tools worked togetherb and autogenerated swagger documentation

FastAPI: Web framework for building APIs with Python
SQLAlchemy: ORM for python 
Pydantic: Model Validation, integrates well with FastAPi for swagger documentation




# Path to Production

The API Server is running in a container making it easy to host on an EC2 using a 

However, were this meant for production, being AWS based I would have preferences a cloud native solution for the API's, such as API Gateway with lambda integration to handle the requests. This would allow us to more scale with options such as caching on API Gateway and WAF for security.


# Challenges

It was great getting a chance to work with FastAPI but it definitely had some limitations and difficulties. 

- UUIDS don't work natively with FastAPI and pydantic model validation - I ended up using an autogenerated id for now but in a production system I would use UUID
- Enum's don't work nicely with SQLAlchemy
- Naming: Naming between pydantic schemas, the SQlAlechemy ORM and identifying post (without ids) and responses (same schema with ids) was a challenge

# Future updates

If I was continuing to use this

- Add authentication
- Alembic db migrations
- Asynchronous requests rather than synchronous requests


Crud operations in `src/app/crud` are repetitive, I would neaten up these to make use of a single common query.
##

# TODO:

- authentication
- testing


- ip_address -> still giving string in example

- more descriptive errors -> mac address already exists


sqlalchemy.exc.IntegrityError: (psycopg2.errors.UniqueViolation) duplicate key value violates unique constraint "device_register_mac_address_key"
src-device-api-1  | DETAIL:  Key (mac_address)=(00:1a:2b:3c:3r:5e) already exists.


## summary vs details